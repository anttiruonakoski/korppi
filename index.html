<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

    <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


    <title>Havaintojärjestelmä 2017 kartatdemo</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />

    <link rel="stylesheet" href="bower_components/Leaflet.awesome-markers/dist/leaflet.awesome-markers.css">
    <link rel="stylesheet" href="bower_components/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

   	<style type="text/css">
        body, html {
            padding: 0px;
            margin: 10px;
            height: calc(100%-20px);
        }
        #kartta {
        	width: calc(50%);
        	height: 720px;
        	border: 1px solid black;
        	margin: 0px;
        	padding: 0px;
        }
        #oikea {
    	background: url('images/corrax.jpg');
      background-size: 150px;
    	background-position: right bottom; /*Positioning*/
   		background-repeat: no-repeat; /*Prevent showing multiple background images*/;
      margin-left:0px; 
      padding-left:0px;

		    }

        .leaflet-container {
  		cursor: crosshair !important;
      }

        .fill { 
          min-height: 100%;
          height: 100%;
      }

      .centered_button {
          display: flex;
          justify-content: center;
          margin: 5%;
      }

        .bottom-column
    {
    position: absolute;
    bottom: 0;
    }
  	
  		/*#oikea form {
  		  overflow: hidden;
  		}

  		#oikea label {
  		  float: left;
        clear: left
  		}

  		#oikea input {
  		  float: right;
  		  clear: right;*/
  		}

  

    </style>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>

    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>

    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>

    <script src="bower_components/Proj4Leaflet/src/proj4leaflet.js"></script>
    <script src="bower_components/Leaflet.MML-layers/mmlLayers.js"></script>
    <script src="bower_components/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>

    <script src="bower_components/Leaflet.awesome-markers/dist/leaflet.awesome-markers.js"></script>


  	<script type="text/javascript">

    L.Icon.Default.prototype.options.iconSize;

  		const WFS_SERVICE="https://avaa.tdata.fi/geoserver/paituli/wfs" 

  		const taustakartta = L.tileLayer.mml_wmts({ layer: "taustakartta" });
      const	maastokartta = L.tileLayer.mml_wmts({ layer: "maastokartta" });
      const ortokuva = L.tileLayer.mml("Ortokuva_3067");
      ortokuva.options.minZoom = 8;  

      const taustakartta_uusi = L.tileLayer.mml("Taustakartta_3067");

  		const init_map = {
            crs: L.TileLayer.MML.get3067Proj(),
            center: [66.5, 25.3],
            zoom: 6,
            minZoom: 3,
            maxZoom: 14,
            layers: [maastokartta],    
            maxBounds: [[58.2133,16.16359],
                        [71.2133,36.16359]]
				};

		  const EPSG3067 = L.TileLayer.MML.get3067Proj();
      var marker_l;
				
        function init() {

        	var baseMaps = { 
        		"Taustakartta" : taustakartta,
        		"Maastokartta" : maastokartta,
            "Ilmakuva" : ortokuva,
            "Uusi Taustakartta": taustakartta_uusi
        			 }

            const map = new L.map('kartta', init_map
            );
           	L.control.layers(baseMaps).addTo(map);
            L.control.locate().addTo(map);
            L.control.scale({maxWidth: 400, imperial: false}).addTo(map);


			function onMapClick(e) {   

      if (marker_l) {
        map.removeLayer(marker_l);
      }        

      marker_l = new L.marker(e.latlng, {icon: L.AwesomeMarkers.icon({icon: 'twitter', prefix: 'fa', markerColor: 'cadetblue'}) }).addTo(map);
        
			var piste = EPSG3067.project(e.latlng).toString();
			var piste_temp = piste.replace("Point(", "").replace(")", "").split(", ");
      var n = Math.round(piste_temp[1]).toString();
			var e = Math.round(piste_temp[0]).toString();

      var bbox_koord = e.concat(",",n,",",e,",",n);

    	document.getElementById('n_koord').value = n;
			document.getElementById('e_koord').value = e;

      //poista tarkkuudesta disabled
      document.getElementById('hp_tarkkuus').disabled = false;


      //document.getElementById('paikka_nimi').value = piste_temp;

      function getData() {
			 return $.ajax(WFS_SERVICE,{
        type: 'GET',
        dataType: 'jsonp',
        jsonpCallback: 'getJson',
        data: {
            service: 'WFS',
            version: '2.0.0',
            request: 'GetFeature',
            typeName: 'paituli:mml_hallinto_2017_10k',
            PropertyName: 'NAMEFIN',
            maxFeatures: 10,
            outputFormat: 'text/javascript',
            format_options: 'callback: getJson',
            bbox: bbox_koord
        	}});
      }

      function handleJson(response){ 
      //parsi kuntanimi
      if (response.totalFeatures) {
      document.getElementById('kunta_nimi').value = response.features[0].properties.NAMEFIN;
      document.getElementById('kunta_nimi').classList.remove('is-invalid');
      }
      //kysely ei palauta kohteita -> ulkomailla 
      else { 
      document.getElementById('kunta_nimi').value = '---';
      document.getElementById('kunta_nimi').classList.add('is-invalid');
      }
      }

      getData().done(handleJson);

    		}
		
			map.on('click', onMapClick);
      // map.on('moveend', function() { 
      //      alert(map.getBounds().getSouthWest());
      // });
        }

    // enable tooltips
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    })    

    //enable modal
    $('#myModal').on('shown.bs.modal', function () {
      $('#myInput').focus()
    })    

    </script>

   	</head>

   <body onload="init();">
   <div class="container bg-light">
   		<!-- <div class="row">
		<h3>Tarkista kunta</h3>
   		</div> -->
   		<div class="row">
   			<div class="col-lg-8" id="kartta">
    		</div>  

    <div class="col-lg-4" id="lomake">  
    <div>
    	<form class="needs-validation" novalidate>
  			<fieldset>
    			<legend class="m-0 p-0"><small>Havaintopaikan tiedot</small></legend>
          <div class="form-group">
            <div class="row m-0 p-0 justify-content-end"">
              <div class="col-md-3 mr-1 p-0">
    				    <label class="mb-1"><small>P-koord:</small></label>
    				    <input type="text" class="form-control form-control-sm" id="n_koord" placeholder="0000000" size="8" readonly />
              </div>
              <div class="col-md-3 mx-1 p-0">
    				    <label class="mb-1"><small>I-koord:</small></label>
    				    <input type="text" class="form-control form-control-sm" id="e_koord" placeholder="000000" size="6" readonly />	
              </div>  
              <div class="col-md-4 mx-1 p-0 align-self-end">
                <label class="mb-1"><small>Tarkkuus:</small></label>
                <select class="custom-select form-control-sm" id="hp_tarkkuus" disabled>
                  <option selected value="0">ei määr.</option>
                  <option value="1">alle 50 m</option>
                  <option value="2">alle 200 m</option>
                  <option value="3">alle 1 km</option>
                  <option value="3">alle 5 km</option>
                  <option value="3">yli 5 km</option>
                  </select> 
              </div> 
              <div class="col ml-1 p-0 align-self-end">   
                  <button type="button" class="btn btn-sm btn-danger" id="btn-clear" data-toggle="tooltip" data-placement="bottom" title="Tyhjennä koordinaatit"><i class="fa fa-times" aria-hidden="true"></i></button>
              </div> 
            </div>   

    				<label><small>Kunta:</small></label>
    				<input type="text" class="form-control form-control-sm" id="kunta_nimi" value="Rovaniemi" size="25" readonly />
                <div class="invalid-feedback">
                    Et voi asettaa havaintopaikkaa Suomen ulkopuolelle.
                </div>
          </div>      
          <div class="form-group">
    				<label><small>Paikannimi:</small></label>
    				<input type="text" class="form-control" id="paikka_nimi" size="25">
          </div>  
    		</fieldset>
    	<form>
     </div>  


     <div class="btn-group" role="group btn-group-sm" aria-label="tools">
       <button type="button" class="btn btn-secondary btn-sm" id="btn-observer" data-toggle="tooltip" data-placement="bottom" title="Aseta havainnoija"><i class="fa fa-binoculars" aria-hidden="true"></i></button>
       <button type="button" class="btn btn-secondary btn-sm" id="btn-bird" data-toggle="tooltip" data-placement="bottom" title="Aseta lintu"><i class="fa fa-twitter" aria-hidden="true"></i></button>
     </div>   

     <div class="btn-group" role="group btn-group-sm" aria-label="tools">
        <button type="button" class="btn btn-secondary btn-sm" id="btn-move" data-toggle="tooltip" data-placement="bottom" title="Siirrä karttaa"><i class="fa fa-arrows" aria-hidden="true"></i></button>
     
       <button type="button" class="btn btn-secondary btn-sm" id="btn-distance" data-toggle="tooltip" data-placement="bottom" title="Mittaa matka"><i class="fa fa-arrows-h" aria-hidden="true"></i></button>
       <button type="button" class="btn btn-danger btn-sm" id="btn-clear" data-toggle="tooltip" data-placement="bottom" title="Tyhjennä paikkatiedot"><i class="fa fa-trash" aria-hidden="true"></i></button>
       
     </div> 

    <div class="py-4" >
<!--            <p><button class="btn btn-dark" type="button">Merkitse paikka</button></p>
 -->            <button class="btn btn-primary btn-sm" type="button" ><i class="fa fa-check fa-1x" aria-hidden="true"></i> Tallenna omiin paikkoihin</button>
    </div>

    <div class="py-4 mx-auto" >
<!--            <p><button class="btn btn-dark" type="button">Merkitse paikka</button></p>
 -->            <button class="btn btn-primary btn-sm" type="button"><i class="fa fa-check fa-1x" aria-hidden="true"></i> Hyväksy paikka</button>
    </div>
    <div class="bottom-column">
          
          <button type="button" class="btn btn-info" data-toggle="modal" data-target="#tietoa_sivusta">
          <i class="fa fa-info fa-1x" aria-hidden="true"></i> Sivusta
          </button>   

          <!-- Modal -->
          <div class="modal fade" id="tietoa_sivusta" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Mikä tämä sivu on?</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>Luonnos siitä millainen lintuhavaintojärjestelmän karttapohja voisi olla vuonna 2017 ja tulevaisuudessa. Teknisiä kohokohtia:
                  <ul>
                    <li>Havaintokunta määräytyy koordinaattipisteen perusteella. Havaintopaikan tallentaminen ulkomaahan on estetty.</li>
                    <li>Kartan voi paikantaa sijaintiin, jossa työskennellään.</li>
                    <li>3-4 nopeasti latautuvaa taustakarttaa.</li>
                    <li>Automaattiset paikannimiehdotukset (tulossa).</li>
                  </ul></p>
                  <p>Aineistolähteet:
                  <ul>
                    <li>Maastokartta ja taustakartta: MML paikkatiedon testipalvelu 2017, WMTS</li>
                    <li>Ilmakuva: WMTS-palvelu kartat.kapsi.fi, kuva-aineisto MML 2017 </li>
                    <li>Kuntarajat 1:10 000: WFS-palvelu Paituli / CSC - Tieteen tietotekniikan keskus, aineisto MML 2017</li>
                  </ul></p>
                  <p>Tekniikat:
                  <ul>
                    <li>Leaflet 1.2, Leaflet.MML-layers, Proj4.js, Proj4leaflet.js</li>
                    <li>Bootstrap 4.0</li>
                  </ul></p>
                  <p>Toteutus:</p> 
                  <address>Antti Ruonakoski <span class="text-secondary">aruonakoski@gmail.com</span></address>
                  
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" data-dismiss="modal">Selvä!</button>
                </div>
              </div>
            </div>
          </div>     

    </div>  
   </div>  
   </div>
   </div>  

	</body>

<!--jos vapaus, sananvastuuta ei ole-->
  
</html>